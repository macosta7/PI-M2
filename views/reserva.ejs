<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Reservar Sala</title>
  <link rel="stylesheet" href="/css/reserva.css" />
</head>
<body>
  <!-- Header -->
  <div class="header">
    <img src="/img/checkin-room.png" alt="Logo Checkin Room" class="logo" />
    <div class="header-icons">
      <div class="notification-container">
        <img src="/img/sino.png" alt="Notifica√ß√µes" class="icone-sino" id="notification-bell" />
        <% if (typeof notificacoes !== 'undefined' && notificacoes.length > 0) { %>
          <span class="notification-badge"><%= notificacoes.length %></span>
        <% } %>

        <!-- Pop-up de notifica√ß√µes -->
        <div class="notification-popup" id="notification-popup">
          <div class="notification-header">
            <h3>Notifica√ß√µes</h3>
          </div>
          <div class="notification-content">
            <% if (typeof notificacoes !== 'undefined' && notificacoes.length > 0) { %>
              <% notificacoes.forEach(n => { %>
                <div class="notification-item">
                  <div class="notification-status <%= n.status_reserva === 'aprovada' ? 'aprovada' : 'rejeitada' %>">
                    <%= n.status_reserva === 'aprovada' ? '‚úÖ' : '‚ùå' %>
                  </div>
                  <div class="notification-details">
                    <div class="notification-text">
                      <strong>Sala <%= n.nm_sala %></strong><br>
                      <%= new Date(n.data_reserva).toLocaleDateString('pt-BR') %><br>
                      <%= n.horario_inicio %> - <%= n.horario_fim %>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <div class="no-notifications">
                <p>Nenhuma notifica√ß√£o encontrada</p>
              </div>
            <% } %>
          </div>
        </div>
      </div>
      <a href="/editar-perfil"><img src="/img/perfil.png" class="foto-perfil" alt="Perfil" /></a>
    </div>
  </div>

  <!-- T√≠tulo centralizado -->
  <h1 class="titulo">Reservar Sala</h1>

  <!-- Formul√°rio de sele√ß√£o de sala -->
  <div class="sala-selector-container">
    <form class="sala-select-form" action="/reserva/disponiveis" method="POST" id="salaForm">
      <select name="id_sala" id="sala-select" required>
        <option value="">Selecione uma sala...</option>
        <% salas.forEach(sala => { %>
          <option value="<%= sala.id_sala %>" <%= sala.id_sala == salaSelecionada ? "selected" : "" %>>
            <%= sala.nm_sala %>
          </option>
        <% }) %>
      </select>
      <input type="hidden" name="data_reserva" id="data-hidden" value="<%= dataSelecionada || '' %>" />
    </form>
  </div>

  <!-- Container principal com calend√°rio e hor√°rios -->
  <div class="main-container">
    <!-- Calend√°rio -->
    <div class="calendario-container">
      <div class="calendario">
        <div class="calendario-header">
          <button type="button" class="nav-btn" id="prev-month">&lt;</button>
          <h3 id="mes-ano"></h3>
          <button type="button" class="nav-btn" id="next-month">&gt;</button>
        </div>
        <div class="calendario-grid">
          <div class="dia-semana">Dom</div>
          <div class="dia-semana">Seg</div>
          <div class="dia-semana">Ter</div>
          <div class="dia-semana">Qua</div>
          <div class="dia-semana">Qui</div>
          <div class="dia-semana">Sex</div>
          <div class="dia-semana">S√°b</div>
          <!-- Dias ser√£o inseridos via JavaScript -->
        </div>
      </div>
    </div>

    <!-- Hor√°rios -->
    <div class="horarios-container">
      <% if (typeof horarios !== 'undefined' && dataSelecionada) { %>
        <div class="horarios">
          <h3 class="data-selecionada">
            <%= new Date(dataSelecionada).toLocaleDateString('pt-BR', {
              weekday: 'long',
              day: '2-digit',
              month: '2-digit',
              year: 'numeric'
            }) %>
          </h3>

          <form action="/reserva" method="POST" class="horarios-form">
            <input type="hidden" name="id_sala" value="<%= salaSelecionada %>" />
            <input type="hidden" name="data_reserva" value="<%= dataSelecionada %>" />

            <% horarios.forEach(h => { %>
              <div class="horario-linha">
                <div class="horario-info">
                  <span class="icone-relogio">üïê</span>
                  <span class="horario-texto"><%= h.horario_inicio %> - <%= h.horario_fim %></span>
                </div>
                <% if (h.ocupado) { %>
                  <button type="button" class="btn-horario ocupado" disabled>Ocupado</button>
                <% } else { %>
                  <button type="submit" name="id_horario" value="<%= h.id_horario %>" class="btn-horario disponivel">Reservar</button>
                <% } %>
              </div>
            <% }) %>
          </form>
        </div>
      <% } else { %>
        <div class="horarios-placeholder">
          <p>Selecione uma sala e uma data para ver os hor√°rios dispon√≠veis</p>
        </div>
      <% } %>
    </div>
  </div>

  <script>
    // JavaScript para o calend√°rio
    let currentDate = new Date();
    let selectedDate = '<%= dataSelecionada || "" %>';

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    // JavaScript para o popup de notifica√ß√µes
    document.addEventListener('DOMContentLoaded', function() {
      const notificationBell = document.getElementById('notification-bell');
      const notificationPopup = document.getElementById('notification-popup');
      let isPopupVisible = false;

      // Toggle popup ao clicar no sino
      notificationBell.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (isPopupVisible) {
          hideNotificationPopup();
        } else {
          showNotificationPopup();
        }
      });

      // Manter popup vis√≠vel ao passar o mouse sobre ele
      notificationPopup.addEventListener('mouseenter', function() {
        clearTimeout(notificationPopup.hideTimeout);
      });

      // Esconder popup ao sair com o mouse (com delay)
      notificationPopup.addEventListener('mouseleave', function() {
        notificationPopup.hideTimeout = setTimeout(hideNotificationPopup, 300);
      });

      // Esconder popup ao clicar fora
      document.addEventListener('click', function(e) {
        if (!notificationBell.contains(e.target) && !notificationPopup.contains(e.target)) {
          hideNotificationPopup();
        }
      });

      function showNotificationPopup() {
        notificationPopup.style.display = 'block';
        setTimeout(() => {
          notificationPopup.classList.add('show');
        }, 10);
        isPopupVisible = true;
      }

      function hideNotificationPopup() {
        notificationPopup.classList.remove('show');
        setTimeout(() => {
          notificationPopup.style.display = 'none';
        }, 300);
        isPopupVisible = false;
      }
    });

    function updateCalendar() {
      const mesAno = document.getElementById('mes-ano');
      const grid = document.querySelector('.calendario-grid');

      // Atualizar header do m√™s/ano
      mesAno.textContent = currentDate.toLocaleDateString('pt-BR', {
        month: 'long',
        year: 'numeric'
      });

      // Limpar dias anteriores (manter cabe√ßalhos dos dias da semana)
      const diasSemana = grid.querySelectorAll('.dia-semana');
      grid.innerHTML = '';
      diasSemana.forEach(dia => grid.appendChild(dia));

      // Calcular primeiro dia do m√™s e quantos dias tem
      const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      const startDate = firstDay.getDay(); // 0 = domingo

      // Adicionar dias vazios no in√≠cio
      for (let i = 0; i < startDate; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'dia-vazio';
        grid.appendChild(emptyDay);
      }

      // Adicionar dias do m√™s
      for (let day = 1; day <= lastDay.getDate(); day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'dia';
        dayElement.textContent = day;

        const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        const dayDateStr = formatDate(dayDate);

        // Marcar data selecionada
        if (dayDateStr === selectedDate) {
          dayElement.classList.add('selecionado');
        }

        // Desabilitar datas passadas
        if (dayDate < new Date().setHours(0,0,0,0)) {
          dayElement.classList.add('passado');
        } else {
          dayElement.addEventListener('click', () => selectDate(dayDateStr, dayElement));
        }

        grid.appendChild(dayElement);
      }
    }

    function selectDate(dateStr, element) {
      // Remover sele√ß√£o anterior
      document.querySelectorAll('.dia.selecionado').forEach(el => el.classList.remove('selecionado'));

      // Adicionar sele√ß√£o atual
      element.classList.add('selecionado');
      selectedDate = dateStr;

      // Atualizar campo hidden
      document.getElementById('data-hidden').value = dateStr;

      // Submeter formul√°rio se sala estiver selecionada
      const salaSelect = document.getElementById('sala-select');
      if (salaSelect.value) {
        document.getElementById('salaForm').submit();
      }
    }

    // Event listeners para navega√ß√£o do calend√°rio
    document.getElementById('prev-month').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      updateCalendar();
    });

    document.getElementById('next-month').addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      updateCalendar();
    });

    // Event listener para mudan√ßa de sala
    document.getElementById('sala-select').addEventListener('change', function() {
      if (this.value && selectedDate) {
        document.getElementById('salaForm').submit();
      }
    });

    // Inicializar calend√°rio
    if (selectedDate) {
      currentDate = new Date(selectedDate);
    }
    updateCalendar();
  </script>
</body>
</html>
